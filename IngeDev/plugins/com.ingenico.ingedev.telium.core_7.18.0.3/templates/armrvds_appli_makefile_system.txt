#*******************************************************************************
#* %MAKEFILE_FILE_NAME%
#*------------------------------------------------------------------------------
<<if APP
<<if rvds
#* Makefile used to generate the Application binaries (ARM RVDS format).
<<else
#* Makefile used to generate the Application binaries (ARM SDT format).*
<<endif
<<else
#* Makefile used to generate the DLL binaries (ARM SDT format).
<<endif
#* This file was automatically generated by IngeDev. Please, do not edit!
#*******************************************************************************

#-------------------------------------------------------------------------------
# General constants
#-------------------------------------------------------------------------------
EMPTY :=
SPACE := $(EMPTY) $(EMPTY)

#-------------------------------------------------------------------------------
# Project and file names
#-------------------------------------------------------------------------------
# Project name
PROJECT_NAME    := %PROJECT_NAME%
# Compiler version
COMPILER_VERSION	:= %COMPILER_VERSION%
# Configuration name
CFG_NAME        := %CONFIG_NAME%
# Target file name (without extension)
TRG_FILE_NAME   := %TARGET_FILE_NAME%
<<if hasStartupFile
# Startup object file name
STARTUP_OBJ_NAME:= %STARTUP_OBJ_NAME%
<<endif
# Mapping file name (RFU)
#MAPPING_DEF_NAME:= %MAPPING_DEF_NAME%

<<if hasAdditionalMakefilesFilter
#-------------------------------------------------------------------------------
# Include additional makefiles
#-------------------------------------------------------------------------------
%ADDITIONAL_MK_FILES%
<<endif

#-------------------------------------------------------------------------------
# Directories
#-------------------------------------------------------------------------------
# Binaries directory
BIN_DIR         := %BIN_DIR%
# Object directory
OBJ_DIR         := %OBJ_DIR%
# Build files directory
BUILD_FILES_DIR := %BUILD_FILES_DIR%

#-------------------------------------------------------------------------------
# Input files path for the current configuration
#-------------------------------------------------------------------------------
# Build files path
BUILD_FILES_PATH:= $(BUILD_FILES_DIR)/$(CFG_NAME)

#-------------------------------------------------------------------------------
# Output files path for the current configuration
#-------------------------------------------------------------------------------
# Object files path
OBJ_PATH        := $(OBJ_DIR)/$(CFG_NAME)
# Binary files path
BIN_PATH        := $(BIN_DIR)/$(CFG_NAME)

#-------------------------------------------------------------------------------
# Compiler, linker, assembler
#-------------------------------------------------------------------------------
<<if rvds
# Arm Compiler executable
CC              := armcc.exe
# Arm Assembler executable
AS              := armasm.exe
<<else
<<if thumb
# Arm Compiler executable (thumb mode)
CC              := tcc.exe
# Arm Assembler executable (thumb mode)
AS              := tasm.exe
<<else
# Arm Compiler executable (arm mode)
CC              := armcc.exe
# Arm Assembler executable (arm mode)
AS              := armasm.exe
<<endif
<<endif

# Arm Linker executable
LD              := armlink.exe
# Arm binary file transforming executable
FROM_ELF        := fromelf.exe
# Arm Decoder Executable Format (AXF) file
OBJ_DUMP        := decaxf.exe

#-------------------------------------------------------------------------------
# Gnu Win32 tools
#-------------------------------------------------------------------------------
# Remove tool
RM              := rm.exe -fr
# Make directory tool
MKDIR           := mkdir.exe -p
# Copy tool
CP              := cp.exe
# Printf tool
PRINTF          := printf.exe
SET             := set
EXPORT          := export
# File string replacement tool (Global Search And Replace)
GSAR            := gsar.exe -o

#-------------------------------------------------------------------------------
# Includes path used in compilation process
#-------------------------------------------------------------------------------
INCLUDES_PATH   := \
<<if hasUserIncsFilter
%USER_INCLUDES%
<<endif
<<if hasPackagesIncsFilter
%PACKAGES_INCLUDES%
<<endif

<<if hasUserAsmIncsFilter
#-------------------------------------------------------------------------------
# Includes path used in assembler process
#-------------------------------------------------------------------------------
INCLUDES_ASM_PATH   := \
%USER_AS_INCLUDES%
<<endif

#-------------------------------------------------------------------------------
# Libraries to be included during link operation
#-------------------------------------------------------------------------------
LIBS            := \
<<if hasSimpleLibsFilter
%SIMPLE_LIBS%
<<endif
<<if hasImportedLibsFilter
%IMPORTED_LIBS%
<<endif
<<if hasProjectLibsFilter
%PROJECT_LIBS%
<<endif
<<if hasPackagesLibsFilter
%PACKAGES_LIBS%
<<endif

#-------------------------------------------------------------------------------
# Compilation and link input files
#-------------------------------------------------------------------------------
# Mapping file location (used during link process) (RFU)
<<if hasMappingDef
MAP_DEF_LOCATION:= %MAP_DEF_FILE%
<<else
#MAP_DEF_LOCATION:= $(BUILD_FILES_PATH)/$(MAPPING_DEF_NAME)
<<endif

#-------------------------------------------------------------------------------
# Result output files
#-------------------------------------------------------------------------------
# Binary file
BINARY_FILE     := $(BIN_PATH)/$(TRG_FILE_NAME).BIN

#-------------------------------------------------------------------------------
# Result Listing files
#-------------------------------------------------------------------------------
# Binary file
LST_FILE     := $(OBJ_PATH)/$(TRG_FILE_NAME).lst

#-------------------------------------------------------------------------------
# Intermediate files
#-------------------------------------------------------------------------------
# MAP file location
INTER_MAP_FILE  := $(OBJ_PATH)/$(TRG_FILE_NAME).map
# AXF file location
INTER_AXF_FILE  := $(OBJ_PATH)/$(TRG_FILE_NAME).axf
# Compiler options file location
INTER_CC_OPTS   := $(OBJ_PATH)/cc.opt
# Assembler options file location
INTER_AS_OPTS   := $(OBJ_PATH)/as.opt
# Linker options file location
INTER_LD_OPTS   := $(OBJ_PATH)/ld.opt
# Default linker options
OD_DEF_OPTS     := %DEFAULT_OD_OPTIONS%

#-------------------------------------------------------------------------------
# Specific compiler, linker, assembler options
#-------------------------------------------------------------------------------
# Specific compiler options
CC_SPEC_OPTS    := %USER_CC_OPTIONS% %DEFAULT_DEFINE%
<<if hasPackagesDefinesFilter
CC_SPEC_OPTS    += %PACKAGES_DEFINES%
<<endif
CC_SPEC_OPTS    += %USER_DEFINES% $(INCLUDES_PATH)
# Specific assembler options
AS_SPEC_OPTS    := %USER_AS_OPTIONS% %USER_AS_DEFINES% $(INCLUDES_PATH)
# Specific linker options
LD_SPEC_OPTS    := %USER_LD_OPTIONS%
#ObjDump options
OD_OPTS         := $(OD_DEF_OPTS) 

#-------------------------------------------------------------------------------
# SRC_OBJS is the list of the project object files
#-------------------------------------------------------------------------------
SRC_OBJS        := \
%USER_OBJECTS%

#-------------------------------------------------------------------------------
# Dependencies
#-------------------------------------------------------------------------------
DEPENDENCIES    := \
$(BUILD_FILES_PATH)/%MAKEFILE_FILE_NAME%

#===============================================================================
# Rule to make the project
#===============================================================================
#-------------------------------------------------------------------------------
# Rule for the binary files generation
#-------------------------------------------------------------------------------
$(BINARY_FILE): $(INTER_AXF_FILE) \
<<if haslstgeneration
                $(LST_FILE)
<<endif

<<if rvds
	$(FROM_ELF)  --bin --no_debug $<  --output="$@" >/dev/null
<<else
	$(FROM_ELF) -nodebug $< -bin $@ >/dev/null
<<endif
	@$(PRINTF) "'$@' binary file generated.\n"

#===============================================================================
# Rule for the link process
#===============================================================================
#-------------------------------------------------------------------------------
# Rule for the axf file generation
#-------------------------------------------------------------------------------
$(INTER_AXF_FILE): $(INTER_MAP_FILE) $(INTER_LD_OPTS) $(LIBS)
	@$(PRINTF) "'$@' link in progress...\n"
<<if rvds
<<if hasMappingDef
	$(LD) $(LD_SPEC_OPTS) --scatter="$(MAP_DEF_LOCATION)" --via="$(INTER_LD_OPTS)" --output="$@" $(LIBS) >/dev/null
<<else
	$(LD) $(LD_SPEC_OPTS) --via="$(INTER_LD_OPTS)" --output="$@" $(LIBS) >/dev/null
<<endif
<<else
	$(LD) $(LD_SPEC_OPTS) -via $(INTER_LD_OPTS) -o $@ $(LIBS) >/dev/null	
<<endif
	@$(RM) "elf"
	
#-------------------------------------------------------------------------------
# Rule for the map file generation
#-------------------------------------------------------------------------------
<<if hasMappingDef
$(INTER_MAP_FILE): $(SRC_OBJS) $(MAP_DEF_LOCATION)  $(INTER_LD_OPTS) $(LIBS)
<<else
$(INTER_MAP_FILE): $(SRC_OBJS)  $(INTER_LD_OPTS) $(LIBS)
<<endif
<<if hasStartupFile
	@$(CP) "%DEFAULT_SYSTEM_OBJ_PATH%\$(STARTUP_OBJ_NAME)" "$(OBJ_PATH)"
<<endif
<<if rvds
<<if hasMappingDef
	$(LD) $(LD_SPEC_OPTS) --map --list="$@" --scatter="$(MAP_DEF_LOCATION)" --via="$(INTER_LD_OPTS)" $(LIBS) 
<<else
	$(LD) $(LD_SPEC_OPTS) --map --list="$@"  --via="$(INTER_LD_OPTS)"  $(LIBS) 
<<endif
<<else
	$(LD) $(LD_SPEC_OPTS) -via $(INTER_LD_OPTS) -list $@ $(LIBS)
<<endif

#===============================================================================
# Rule for the .lst Generation
#===============================================================================
$(LST_FILE): $(INTER_AXF_FILE)
	$(OBJ_DUMP) $(OD_OPTS) $<  > $@
	@$(PRINTF) "'$@' lst file generated.\n"

#===============================================================================
# Rule for the compilation process
#===============================================================================
%COMPILATION_RULES%
<<if hasProjectLibsFilter
#===============================================================================
# Rule use to call dependent project makefiles for build or clean operation
#===============================================================================
.PHONY: callProjectMakefileDependencies
callProjectMakefileDependencies:
%DEPENDENT_PROJECT_MAKEFILES_CALL_RULES%
<<endif
#===============================================================================
# Rule for project name and configuration name display
#===============================================================================
.PHONY: displayInfo
displayInfo:
	@$(PRINTF) "                                     *-*-*\n"
	@$(PRINTF) "--- Project '$(PROJECT_NAME)', Configuration '$(CFG_NAME)', Compiler '$(COMPILER_VERSION)' ---\n"

#===============================================================================
# Rule for build target progress info display
#===============================================================================
.PHONY: displayBuildInProgress
displayBuildInProgress:
	@$(PRINTF) "Build in progress...\n"

#===============================================================================
# Rule for output directories creation
#===============================================================================
.PHONY: createOutputDirs
createOutputDirs:
	@$(MKDIR) "$(OBJ_PATH)"
	@$(MKDIR) "$(BIN_PATH)"

#===============================================================================
# Rules for intermediate option files creation
#===============================================================================
$(INTER_CC_OPTS):
	$(PRINTF) "%DEFAULT_CC_OPTIONS%\n" > $@

$(INTER_AS_OPTS):
	$(PRINTF) "%DEFAULT_AS_OPTIONS%\n" > $@

$(INTER_LD_OPTS):
	$(PRINTF) "%DEFAULT_LD_OPTIONS%\n" > $@
<<if hasldopts
	$(PRINTF) "-ro-base %CODE_BASE_ADDRESS% -rw-base %DATA_BASE_ADDRESS%\n" >> $@
	$(PRINTF) "-first $(OBJ_PATH)/$(STARTUP_OBJ_NAME)(reset)\n" >> $@
	$(PRINTF) "$(OBJ_PATH)/$(STARTUP_OBJ_NAME)\n" >> $@
<<endif
%LINK_FILE_SRC_OBJS%

#===============================================================================
# Make build rule
#===============================================================================
.PHONY: build
<<if hasProjectLibsFilter
build: callProjectMakefileDependencies displayInfo displayBuildInProgress createOutputDirs $(BINARY_FILE)
<<else
build: displayInfo displayBuildInProgress createOutputDirs $(BINARY_FILE)
<<endif
	@$(PRINTF) "done!\n"

#===============================================================================
# Make clean rule
#===============================================================================
.PHONY: clean
<<if hasProjectLibsFilter
clean: callProjectMakefileDependencies displayInfo
<<else
clean: displayInfo
<<endif
	@$(PRINTF) "deleting intermediate files...\n"
	@$(RM) "$(BINARY_FILE)"
ifneq "$(wildcard $(OBJ_PATH)/*.*)" ""
	@$(RM) "$(OBJ_PATH)/*.*"
endif
	@$(PRINTF) "done!\n"
