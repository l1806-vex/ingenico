#*******************************************************************************
#* %MAKEFILE_FILE_NAME%
#*------------------------------------------------------------------------------
#* Makefile used to generate the resource binary (GNU ARM and ARM SDT format).
#* This file was automatically generated by IngeDev. Please, do not edit!
#*******************************************************************************

#-------------------------------------------------------------------------------
# Include variables list set in the runtime-workspace
#-------------------------------------------------------------------------------
include vars.mk

#-------------------------------------------------------------------------------
# General constants
#-------------------------------------------------------------------------------
EMPTY :=
SPACE := $(EMPTY) $(EMPTY)

#-------------------------------------------------------------------------------
# Project and file names - updated by IngeDev
#-------------------------------------------------------------------------------
# Project name
PROJECT_NAME    = %PROJECT_NAME%
# Sub-Project name
SUB_PRJ_NAME    = %SUB_PROJECT_NAME%
# Config name
CFG_NAME        = %CONFIG_NAME%
# Target file name
TRG_FILE_NAME   = %TARGET_FILE_NAME%
# Compiler type
COMPILER_TYPE   = %COMPILER_TYPE%

#-------------------------------------------------------------------------------
# Directories - updated by IngeDev
#-------------------------------------------------------------------------------
# Binaries directory
BIN_DIR         = %BIN_DIR%
# Object directory
OBJ_DIR         = %OBJ_DIR%

#-------------------------------------------------------------------------------
# Input files path for the current sub-project in the current config
#-------------------------------------------------------------------------------
# Sub-project configuration path
CFG_PATH        = $(SUB_PRJ_NAME)/$(CFG_NAME)
# ingRC JAR file path and name
INGRC_JAR_FILE  = $(JAR_FILES_PATH)/ingRC.jar

#-------------------------------------------------------------------------------
# Output files path for the current sub-project in the current config
#-------------------------------------------------------------------------------
# Object files path
OBJ_PATH        = $(OBJ_DIR)/$(SUB_PRJ_NAME)/$(CFG_NAME)
# Binary files path
BIN_PATH        = $(BIN_DIR)/$(CFG_NAME)

<<if keyUsed
#-------------------------------------------------------------------------------
# Key signature parameters - updated by IngeDev
#-------------------------------------------------------------------------------
# Key name
KEY_NAME        = %KEY_NAME%
# Key number
KEY_NUM         = %KEY_NUM%
# Key location
KEY_LOCATION    = $(KEY_PATH)/$(KEY_NAME)

<<endif
#-------------------------------------------------------------------------------
# Gnu Win32 tools
#-------------------------------------------------------------------------------
# Remove tool
RM              = rm.exe -fr
# Make directory tool
MKDIR           = mkdir.exe -p
# Copy tool
CP              = cp.exe
# Printf tool
PRINTF          = printf.exe
# Files concatenation tool
CAT             = cat.exe

#-------------------------------------------------------------------------------
# Ingenico tools
#-------------------------------------------------------------------------------
# TLV Converter tool
CV              = convtlv.exe
# Signature tool
SG              = ingesign.exe
# Resource compiler tool
RC              = "$(JRE_BIN_PATH)/java" -jar "$(INGRC_JAR_FILE)"

#-------------------------------------------------------------------------------
# Input files - updated by IngeDev
#-------------------------------------------------------------------------------
# XML resource file location
XML_RES_LOCATION= $(SUB_PRJ_NAME)/%XML_RESOURCE_FILE_PATH%
# TLV original code file location
TLV_ORIGINAL_CODE_LOCATION= $(CFG_PATH)/code.tlv
# TLV code file location
TLV_CODE_LOCATION= $(OBJ_PATH)/code.tlv

#-------------------------------------------------------------------------------
# Binary result file name
#-------------------------------------------------------------------------------
BIN_RES_FILE    = $(BIN_PATH)/$(TRG_FILE_NAME)

#-------------------------------------------------------------------------------
# Compilation and link intermediate files
#-------------------------------------------------------------------------------
# TPL code file location
INTER_CODE_TPL  = $(OBJ_PATH)/$(TRG_FILE_NAME).tpl
# Resource binary file location
INTER_RES       = $(OBJ_PATH)/$(TRG_FILE_NAME).res
# Resource binary file with header location
BIN_RES         = $(OBJ_PATH)/$(TRG_FILE_NAME).bin

#===============================================================================
# Rule to make the resource - updated by IngeDev
#===============================================================================
$(BIN_RES_FILE): $(BIN_RES)
<<if signingBox
	@$(SG) PORT \\\\\\\\.\\\\$(SIGNING_BOX_COM_PORT) >/dev/null
<<endif
	@$(SG) APP_CHECK_DEBUG OFF >/dev/null
	@$(SG) SYMBOL_FOLDER "$(OBJ_PATH)" >/dev/null
	@$(SG) TEMPLATE_FOLDER "$(OBJ_PATH)" >/dev/null
	@$(PRINTF) "'$@' signature in progress...\n"
	@$(SG) START_SIGNATURE >/dev/null
ifeq "$(COMPILER_TYPE)" "%GNUARM_COMPILER_TYPE%"
<<if signingBox
	$(SG) "$<" "$@" BYHSC GNU
<<else
	$(SG) "$<" "$@" "$(KEY_LOCATION)" $(KEY_NUM) GNU
<<endif
else
<<if signingBox
	$(SG) "$<" "$@" BYHSC ARM
<<else
	$(SG) "$<" "$@" "$(KEY_LOCATION)" $(KEY_NUM) ARM
<<endif
endif
	@$(PRINTF) "'$@' resource file generated.\n"

#===============================================================================
# Rule to convert XML file to RES file
#===============================================================================
$(INTER_RES): $(XML_RES_LOCATION)
	$(RC) "$<" "$@"

#===============================================================================
# Rule to convert TLV files to TPL files
#===============================================================================
$(INTER_CODE_TPL): $(TLV_CODE_LOCATION)
	$(CV) "$(subst /,\\,$<)" "$(subst /,\\,$@)" /l

#===============================================================================
# Rule to create resource file binary
#===============================================================================
$(BIN_RES): $(INTER_CODE_TPL) $(INTER_RES)
	@$(CAT) "$(INTER_CODE_TPL)" "$(INTER_RES)" > "$@"

#===============================================================================
# Rule to display sub-project name and configuration name
#===============================================================================
.PHONY: displayInfo
displayInfo:
	@$(PRINTF) "                                     *-*-*\n"
	@$(PRINTF) "--- Project '$(PROJECT_NAME)', Sub-project '$(SUB_PRJ_NAME)', Configuration '$(CFG_NAME)' ---\n"

#===============================================================================
# Rule to create output directories if it not already exist
#===============================================================================
.PHONY: createOutputDirs
createOutputDirs:
	@$(MKDIR) "$(OBJ_PATH)"
	@$(MKDIR) "$(BIN_PATH)"

#===============================================================================
# Rule to copy original TLV code file to object directory
#===============================================================================
$(TLV_CODE_LOCATION): $(TLV_ORIGINAL_CODE_LOCATION)
	@$(CP) "$(TLV_ORIGINAL_CODE_LOCATION)" "$(OBJ_PATH)"
	
#===============================================================================
# Make build rule
#===============================================================================
.PHONY: build
build: displayInfo createOutputDirs $(TLV_CODE_LOCATION) $(BIN_RES_FILE)
	@$(PRINTF) "done!\n"

#===============================================================================
# Make clean rule
#===============================================================================
.PHONY: clean
clean: displayInfo
	@$(PRINTF) "deleting intermediate files...\n"
	@$(RM) "$(BIN_RES_FILE)"
ifneq "$(wildcard $(OBJ_PATH)/*.*)" ""
	@$(RM) "$(OBJ_PATH)/*.*"
endif
	@$(PRINTF) "done!\n"
